<html><head><title>fs2: Concurrency Primitives</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="co.fs2" /><meta name="description" content="fs2 - Functional Streams for Scala" /><meta name="og:image" content="/fs2/img/poster.png" /><meta name="og:title" content="fs2: Concurrency Primitives" /><meta name="og:site_name" content="fs2" /><meta name="og:url" content="https://github.com/functional-streams-for-scala/fs2" /><meta name="og:type" content="website" /><meta name="og:description" content="fs2 - Functional Streams for Scala" /><link rel="icon" type="image/png" href="/fs2/img/favicon.png" /><meta name="twitter:title" content="fs2: Concurrency Primitives" /><meta name="twitter:image" content="https://github.com/functional-streams-for-scala/fs2img/poster.png" /><meta name="twitter:description" content="fs2 - Functional Streams for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/fs2/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/fs2/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/fs2/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/fs2/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/fs2/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/fs2/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/fs2/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/fs2/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/fs2/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/fs2/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/fs2/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/fs2/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/fs2/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/fs2/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/fs2/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/fs2/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/fs2/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/fs2/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/fs2/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/fs2/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/fs2/highlight/styles/default.css" /><link rel="stylesheet" href="/fs2/css/style.css" /><link rel="stylesheet" href="/fs2/css/palette.css" /><link rel="stylesheet" href="/fs2/css/codemirror.css" /></head><body><header id="site-header"><div class="navbar-wrapper navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/fs2/" class="brand"><div class="icon-wrapper"><span>fs2</span></div></a></div><nav class="text-right"><ul class=""><li><a href="https://github.com/functional-streams-for-scala/fs2"><i class="fa fa-github"></i><span class="hidden-xs">GitHub</span></a></li></ul></nav></div></div><div class="jumbotron" style="background-image:url('/fs2/img/jumbotron_pattern.png')"></div><div><ul class="horizontalNav">     <li><a class="" href="/fs2/">Home</a></li>  <li><a class="" href="/fs2/guide.html">Guide</a></li>  <li><a class=" active " href="/fs2/concurrency-primitives.html">Concurrency Primitives</a></li>  <li><a class="" href="/fs2/faq.html">FAQ</a></li> </ul></div></header><main id="site-main"><section class="use"><div class="container"><div id="content"><h1 id="concurrency-primitives">Concurrency Primitives</h1>

<p>In the <a href="https://github.com/functional-streams-for-scala/fs2/blob/series/0.10/core/shared/src/main/scala/fs2/async/async.scala"><code class="highlighter-rouge">fs2.async</code> package object</a> you’ll find a bunch of useful concurrency primitives:</p>

<ul>
  <li><code class="highlighter-rouge">Ref[F, A]</code></li>
  <li><code class="highlighter-rouge">Promise[F, A]</code></li>
  <li><code class="highlighter-rouge">Queue[F, A]</code></li>
  <li><code class="highlighter-rouge">Topic[F, A]</code></li>
  <li><code class="highlighter-rouge">Signal[F, A]</code></li>
  <li><code class="highlighter-rouge">Semaphore[F]</code></li>
</ul>

<p>These data structures could be very handy in a few cases. See below examples of each of them originally taken from <a href="https://github.com/gvolpe/advanced-http4s/tree/master/src/main/scala/com/github/gvolpe/fs2">gvolpe examples</a>:</p>

<h3 id="concurrent-counter">Concurrent Counter</h3>

<p>This is probably one of the most common uses of the primitive <code class="highlighter-rouge">fs2.async.Ref[F, A]</code>.</p>

<p>The workers will concurrently run and modify the value of the Ref so this is one possible outcome showing “#worker » currentCount”:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#1 &gt;&gt; 0
#3 &gt;&gt; 0
#2 &gt;&gt; 0
#1 &gt;&gt; 2
#2 &gt;&gt; 3
#3 &gt;&gt; 3
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.StreamApp.ExitCode</span>
<span class="k">import</span> <span class="nn">fs2.async.Ref</span>
<span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Scheduler</span><span class="o">,</span> <span class="nc">Sink</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">,</span> <span class="nc">StreamApp</span><span class="o">,</span> <span class="n">async</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>

<span class="k">class</span> <span class="nc">Worker</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">number</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">ref</span><span class="k">:</span> <span class="kt">Ref</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span><span class="o">.</span><span class="n">evalMap</span><span class="o">(</span><span class="n">n</span> <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"#$number &gt;&gt; $n"</span><span class="o">)))</span>

  <span class="k">def</span> <span class="n">start</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span><span class="o">).</span><span class="n">to</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="n">modify</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">ref</span><span class="o">.</span><span class="n">get</span><span class="o">).</span><span class="n">to</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">Counter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="kt">:</span> <span class="kt">Effect</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">StreamApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">stream</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">requestShutdown</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Scheduler</span><span class="o">(</span><span class="n">corePoolSize</span> <span class="k">=</span> <span class="mi">10</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">S</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">ref</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="n">refOf</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">0</span><span class="o">))</span>
        <span class="n">w1</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="mi">1</span><span class="o">,</span> <span class="n">ref</span><span class="o">)</span>
        <span class="n">w2</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="mi">2</span><span class="o">,</span> <span class="n">ref</span><span class="o">)</span>
        <span class="n">w3</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="mi">3</span><span class="o">,</span> <span class="n">ref</span><span class="o">)</span>
        <span class="n">ec</span>  <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">(</span><span class="n">w1</span><span class="o">.</span><span class="n">start</span><span class="o">,</span> <span class="n">w2</span><span class="o">.</span><span class="n">start</span><span class="o">,</span> <span class="n">w3</span><span class="o">.</span><span class="n">start</span><span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="n">drain</span> <span class="o">++</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">ec</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="only-once">Only Once</h3>

<p>Whenever you are in a scenario when many processes can modify the same value but you only care about the first one in doing so and stop processing, then this is the use case of a <code class="highlighter-rouge">fs2.async.Promise[F, A]</code>.</p>

<p>Two processes will try to complete the promise at the same time but only one will succeed, completing the promise exactly once. The loser one will raise an error when trying to complete a promise already completed, that’s why we call <code class="highlighter-rouge">attempt</code> on the evaluation.</p>

<p>Notice that the loser process will remain running in the background and the program will end on completion of all of the inner streams.</p>

<p>So it’s a “race” in the sense that both processes will try to complete the promise at the same time but conceptually is different from “race”. So for example, if you schedule one of the processes to run in 10 seconds from now, then the entire program will finish after 10 seconds and you can know for sure that the process completing the promise is going to be the first one.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.StreamApp.ExitCode</span>
<span class="k">import</span> <span class="nn">fs2.async.Promise</span>
<span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Scheduler</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">,</span> <span class="nc">StreamApp</span><span class="o">,</span> <span class="n">async</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>

<span class="k">class</span> <span class="nc">ConcurrentCompletion</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">p</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">attemptPromiseCompletion</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">complete</span><span class="o">(</span><span class="n">n</span><span class="o">)).</span><span class="n">attempt</span><span class="o">.</span><span class="n">drain</span>

  <span class="k">def</span> <span class="n">start</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Stream</span><span class="o">(</span>
      <span class="n">attemptPromiseCompletion</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
      <span class="n">attemptPromiseCompletion</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span>
      <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="o">).</span><span class="n">evalMap</span><span class="o">(</span><span class="n">n</span> <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Result: $n"</span><span class="o">)))</span>
    <span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="n">drain</span> <span class="o">++</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">Once</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Effect</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">StreamApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">stream</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">requestShutdown</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Scheduler</span><span class="o">(</span><span class="n">corePoolSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">scheduler</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">p</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="n">promise</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">])</span>
        <span class="n">e</span> <span class="k">&lt;-</span> <span class="k">new</span> <span class="nc">ConcurrentCompletion</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">p</span><span class="o">).</span><span class="n">start</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">e</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="fifo-first-in--first-out">FIFO (First IN / First OUT)</h3>

<p>A typical use case of a <code class="highlighter-rouge">fs2.async.mutable.Queue[F, A]</code>, also quite useful to communicate with the external word as shown in the <a href="guide#talking-to-the-external-world">guide</a>.</p>

<p>q1 has a buffer size of 1 while q2 has a buffer size of 100 so you will notice the buffering when  pulling elements out of the q2.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.StreamApp.ExitCode</span>
<span class="k">import</span> <span class="nn">fs2.async.mutable.Queue</span>
<span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Scheduler</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">,</span> <span class="nc">StreamApp</span><span class="o">,</span> <span class="n">async</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">class</span> <span class="nc">Buffering</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">q1</span><span class="k">:</span> <span class="kt">Queue</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">],</span> <span class="n">q2</span><span class="k">:</span> <span class="kt">Queue</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">start</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Stream</span><span class="o">(</span>
      <span class="nc">Stream</span><span class="o">.</span><span class="n">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1000</span><span class="o">).</span><span class="n">covary</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="n">to</span><span class="o">(</span><span class="n">q1</span><span class="o">.</span><span class="n">enqueue</span><span class="o">),</span>
      <span class="n">q1</span><span class="o">.</span><span class="n">dequeue</span><span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="n">q2</span><span class="o">.</span><span class="n">enqueue</span><span class="o">),</span>
      <span class="c1">//.map won't work here as you're trying to map a pure value with a side effect. Use `evalMap` instead.
</span>      <span class="n">q2</span><span class="o">.</span><span class="n">dequeue</span><span class="o">.</span><span class="n">evalMap</span><span class="o">(</span><span class="n">n</span> <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Pulling out $n from Queue #2"</span><span class="o">)))</span>
    <span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">Fifo</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Effect</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">StreamApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">stream</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">requestShutdown</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Scheduler</span><span class="o">(</span><span class="n">corePoolSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">S</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">q1</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="n">boundedQueue</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">1</span><span class="o">))</span>
        <span class="n">q2</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="n">boundedQueue</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">100</span><span class="o">))</span>
        <span class="n">bp</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Buffering</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">q1</span><span class="o">,</span> <span class="n">q2</span><span class="o">)</span>
        <span class="n">ec</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">).</span><span class="n">covary</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span> <span class="n">concurrently</span> <span class="n">bp</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">drain</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">ec</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="single-publisher--multiple-subscriber">Single Publisher / Multiple Subscriber</h3>

<p>Having a Kafka like system built on top of concurrency primitives is possible by making use of <code class="highlighter-rouge">fs2.async.mutable.Topic[F, A]</code>. In this more complex example, we will also show you how to make use of a <code class="highlighter-rouge">fs2.async.mutable.Signal[F, A]</code> to interrupt a scheduled Stream.</p>

<p>The program ends after 15 seconds when the signal interrupts the publishing of more events given that the final streaming merge halts on the end of its left stream (the publisher).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Subscriber #1 should receive 15 events + the initial empty event
- Subscriber #2 should receive 10 events
- Subscriber #3 should receive 5 events
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.StreamApp.ExitCode</span>
<span class="k">import</span> <span class="nn">fs2.async.mutable.</span><span class="o">{</span><span class="nc">Signal</span><span class="o">,</span> <span class="nc">Topic</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Scheduler</span><span class="o">,</span> <span class="nc">Sink</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">,</span> <span class="nc">StreamApp</span><span class="o">,</span> <span class="n">async</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Event</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">class</span> <span class="nc">EventService</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">eventsTopic</span><span class="k">:</span> <span class="kt">Topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">],</span>
                         <span class="n">interrupter</span><span class="k">:</span> <span class="kt">Signal</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Boolean</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Scheduler</span><span class="o">)</span> <span class="o">{</span>

  <span class="c1">// Publishing events every one second until signaling interruption
</span>  <span class="k">def</span> <span class="n">startPublisher</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">S</span><span class="o">.</span><span class="n">awakeEvery</span><span class="o">(</span><span class="mf">1.</span><span class="n">second</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">event</span> <span class="k">=</span> <span class="nc">Event</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">().</span><span class="n">toString</span><span class="o">)</span>
      <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">eventsTopic</span><span class="o">.</span><span class="n">publish1</span><span class="o">(</span><span class="n">event</span><span class="o">))</span>
    <span class="o">}.</span><span class="n">interruptWhen</span><span class="o">(</span><span class="n">interrupter</span><span class="o">)</span>

  <span class="c1">// Creating 3 subscribers in a different period of time and join them to run concurrently
</span>  <span class="k">def</span> <span class="n">startSubscribers</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">s1</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">]</span> <span class="k">=</span> <span class="n">eventsTopic</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">s2</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">]</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">eventsTopic</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span> <span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">s3</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">]</span> <span class="k">=</span> <span class="n">S</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">eventsTopic</span><span class="o">.</span><span class="n">subscribe</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span>

    <span class="k">def</span> <span class="n">sink</span><span class="o">(</span><span class="n">subscriberNumber</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">]</span> <span class="k">=</span>
      <span class="k">_</span><span class="o">.</span><span class="n">evalMap</span><span class="o">(</span><span class="n">e</span> <span class="k">=&gt;</span> <span class="n">F</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Subscriber #$subscriberNumber processing event: $e"</span><span class="o">)))</span>

    <span class="nc">Stream</span><span class="o">(</span><span class="n">s1</span><span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="n">sink</span><span class="o">(</span><span class="mi">1</span><span class="o">)),</span> <span class="n">s2</span><span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="n">sink</span><span class="o">(</span><span class="mi">2</span><span class="o">)),</span> <span class="n">s3</span><span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="n">sink</span><span class="o">(</span><span class="mi">3</span><span class="o">))).</span><span class="n">join</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">PubSub</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Effect</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">StreamApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">stream</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">requestShutdown</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Scheduler</span><span class="o">(</span><span class="n">corePoolSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">S</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">topic</span>     <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="n">topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">](</span><span class="nc">Event</span><span class="o">(</span><span class="s">""</span><span class="o">)))</span>
        <span class="n">signal</span>    <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="n">signalOf</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Boolean</span><span class="o">](</span><span class="kc">false</span><span class="o">))</span>
        <span class="n">service</span>   <span class="k">=</span> <span class="k">new</span> <span class="nc">EventService</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">topic</span><span class="o">,</span> <span class="n">signal</span><span class="o">)</span>
        <span class="n">exitCode</span>  <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">(</span>
                      <span class="n">S</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">signal</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)),</span> <span class="mf">15.</span><span class="n">seconds</span><span class="o">),</span>
                      <span class="n">service</span><span class="o">.</span><span class="n">startPublisher</span><span class="o">.</span><span class="n">concurrently</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="n">startSubscribers</span><span class="o">)</span>
                    <span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">drain</span> <span class="o">++</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">exitCode</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="shared-resource">Shared Resource</h3>

<p>When multiple processes try to access a precious resource you might want to constraint the number of accesses. Here is where <code class="highlighter-rouge">fs2.async.mutable.Semaphore[F]</code> comes in useful.</p>

<p>Three processes are trying to access a shared resource at the same time but only one at a time will be granted access and the next process have to wait until the resource gets available again (availability is one as indicated by the semaphore counter).</p>

<p>R1, R2 &amp; R3 will request access of the precious resource concurrently so this could be one possible outcome:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R1 &gt;&gt; Availability: 1
R2 &gt;&gt; Availability: 1
R2 &gt;&gt; Started | Availability: 0
R3 &gt;&gt; Availability: 0
--------------------------------
R1 &gt;&gt; Started | Availability: 0
R2 &gt;&gt; Done | Availability: 0
--------------------------------
R3 &gt;&gt; Started | Availability: 0
R1 &gt;&gt; Done | Availability: 0
--------------------------------
R3 &gt;&gt; Done | Availability: 1
</code></pre></div></div>

<p>This means when R1 and R2 requested the availability it was one and R2 was faster in getting access to the resource so it started processing. R3 was the slowest and saw that there was no availability from the beginning.</p>

<p>Once R2 was done R1 started processing immediately showing no availability.
Once R1 was done R3 started processing immediately showing no availability.
Finally, R3 was done showing an availability of one once again.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.syntax.functor._</span>
<span class="k">import</span> <span class="nn">fs2.StreamApp.ExitCode</span>
<span class="k">import</span> <span class="nn">fs2.async.mutable.Semaphore</span>
<span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Scheduler</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">,</span> <span class="nc">StreamApp</span><span class="o">,</span> <span class="n">async</span><span class="o">}</span>

<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">class</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Effect</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">s</span><span class="k">:</span> <span class="kt">Semaphore</span><span class="o">[</span><span class="kt">F</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Scheduler</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">use</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">available</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"$name &gt;&gt; Availability: $a"</span><span class="o">)))</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">decrement</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">available</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"$name &gt;&gt; Started | Availability: $a"</span><span class="o">)))</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">S</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">increment</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">available</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"$name &gt;&gt; Done | Availability: $a"</span><span class="o">)))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">Resources</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Effect</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">StreamApp</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">stream</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="n">requestShutdown</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">])</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Scheduler</span><span class="o">(</span><span class="n">corePoolSize</span> <span class="k">=</span> <span class="mi">4</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">scheduler</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="n">s</span>   <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">async</span><span class="o">.</span><span class="n">semaphore</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="mi">1</span><span class="o">))</span>
        <span class="n">r1</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="s">"R1"</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
        <span class="n">r2</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="s">"R2"</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
        <span class="n">r3</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="s">"R3"</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
        <span class="n">ec</span>  <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">(</span><span class="n">r1</span><span class="o">.</span><span class="n">use</span><span class="o">,</span> <span class="n">r2</span><span class="o">.</span><span class="n">use</span><span class="o">,</span> <span class="n">r3</span><span class="o">.</span><span class="n">use</span><span class="o">).</span><span class="n">join</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="n">drain</span> <span class="o">++</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="nc">ExitCode</span><span class="o">.</span><span class="nc">Success</span><span class="o">)</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">ec</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
</div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><div class="col-xs-6"><p>fs2 is designed and developed by <a href="https://github.com/functional-streams-for-scala/fs2" target="_blank">co.fs2</a></p></div><div class="col-xs-6"><p class="text-right"><a href="https://github.com/functional-streams-for-scala/fs2"><span class="fa fa-github"></span>View on GitHub</a></p></div></div><div class="row"><div class="col-xs-6"><p>Website built with <a href="https://47deg.github.io/sbt-microsites/" target="_blank">Sbt-microsites</a> - © 2016 <a href="https://www.47deg.com/" target="_blank">47 Degrees</a></p></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/fs2/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'functional-streams-for-scala/fs2'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script></body></html>